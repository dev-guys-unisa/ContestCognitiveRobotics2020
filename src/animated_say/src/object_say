#!/usr/bin/env python
import time
import rospy
from naoqi_driver import NaoqiNode
from collections import Counter
from pepper_detector.msg import DetectionWithPose

initial_phrase = "Okay, ^start(animations/Stand/Gestures/Explain_6) I think I saw something."

class ObjectSay(NaoqiNode):

    def __init__(self):
        NaoqiNode.__init__(self, 'welcome_say')
        self.connectNaoqi()
        self.pictures = 0
        self.msg = ""
        self.counter = Counter()
        pass

    def init_subs(self, topic):
        self.say_sub = rospy.Subscriber(topic, DetectionWithPose, self.callback)

    def connectNaoqi(self):
        # Speech Proxy attachment
        self.speech = self.get_proxy("ALAnimatedSpeech")

    def say(self, msg):
        # Sending phrase and bodyLanguage to Pepper
        # self.speech.setParameter("speed", 75)
        self.speech.say(msg, {"bodyLanguageMode":"contextual"})
        #

    def callback(self, data):
        self.pictures += 1
        self.msg += "\RSPD=" + str(65) + "\ On the " if self.pictures == 1 else "Then, on the" 
        self.msg += str(data.pose.data) + "side, I see ^start(animations/Stand/Gestures/Explain_10) "
        for s in data.detections:
            self.counter[s.data] += 1
        for x in self.counter:
            if self.counter[x] == 1:
                self.msg += "an " if self._is_vowel(x[0]) else "a "
                self.msg += x + ", "
            else:
                self.msg += str(self.counter[x]) + " " + x + "s, "
        self.msg += "and nothing more."
        self.counter.clear()
        if self.pictures == 3:
            self.say(self.msg)
            rospy.loginfo(self.msg)

    def _is_vowel(self, char):
        if (char == 'a' or char == 'e' or char == 'i' or char == 'o' or char == 'u'):
            return True
        else:
            return False

    

if __name__ == "__main__":
    wlcm = ObjectSay()
    msg = "\RSPD=" + str(65) + "\ Hi, ^start(animations/Stand/Gestures/Hey_6) let me see what I can find."
    wlcm.say(msg)
    wlcm.init_subs("/pepper_detective")
    rospy.spin()
